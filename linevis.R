library(ggplot2)

#' Loads commit stats (as generated by cloc) into a data frame, along with the commit ref and timestamp.
#' @export
#' @return data.frame of all commit line count stats
#' @examples
#' commit_stats <- load_commit_stats()
#' summary(commit_stats)
load_commit_stats <- function() {
  library(plyr)

  commits <- read.csv('out/commits.csv', header=FALSE, col.names=c('ref','timestamp'))

  dat <- adply(
    .data=commits,
    .margins=1,
    .fun=function(c) {
      f <- sprintf('./out/%s.csv', c$ref)
      if(file.exists(f)) {
        d <- read.csv(f)
        d <- d[grep("http", names(d), value=TRUE, invert=TRUE)] # Exclude "trash" columns
        d$ref <- c$ref
        d$timestamp <- as.POSIXct(c$timestamp)
        d
      }
    }
  )

  dat$lines_of_code_per_file <- dat$code/dat$files
  dat

}

#' Gets a subset of brand colors for the plots.
#' @export
commit_stat_colors <- function()
  subset(
    brand_colors(),
    Color.Name %in% c('Opower Blue', 'Navy', 'Light Blue', 'Magenta', 'Bright Orange', 'Dark Grey', 'Yellow')
  )$Hex

#' Plots the variable for each language at each commit time.
#' @export
#' @param commit_stats
#' @param variable the variable to plot
#' @param title the plot title
#' @return ggplot object
plot_commit_stats<- function(commit_stats, variable, title) {
  ggplot(commit_stats, aes_string(x = 'timestamp', y = variable, colour = 'language')) +
    opts(
      title=title,
      legend.key = theme_blank(),
      legend.key.size = unit(2, 'lines'),
      legend.text = theme_text(hjust=0, size=20),
      legend.title = theme_text(hjust=0, size=20)
    )
}

#' Plots the variable as an area chart vs. Time + languages.
#' @export
#' @param commit_stats
#' @param variable the variable to plot
#' @param title the plot title
#' @return ggplot object
plot_commit_stats_area <- function(commit_stats, variable, title)
    plot_commit_stats(commit_stats, variable, title) +
      geom_area(aes(fill = language), position = 'stack') +
      scale_fill_manual(values=commit_stat_colors())

#' Plots the variable as a line chart vs. Time + languages.
#' @export
#' @param commit_stats
#' @param variable the variable to plot
#' @param title the plot title
#' @return ggplot object
plot_commit_stats_line <- function(commit_stats, variable, title)
    plot_commit_stats(commit_stats, variable, title) +
      geom_line(aes(colour = language), size=2) +
      scale_colour_manual(values=commit_stat_colors())

#' Plot all to PNG.
#' @export
#' @param commit_stats
plot_all_to_PNG <- function(commit_stats) {
  plot_to_png <- function(variable, title, FUN) {
    png(sprintf('./commit_%s.png', variable), height=900, width=1600)
    print(FUN(commit_stats, variable, title))
    dev.off()
  }
  plot_to_png('code', 'Lines of code over time, by language', FUN=plot_commit_stats_area)
  plot_to_png('files', 'Number of files over time, by language', FUN=plot_commit_stats_line)
  plot_to_png('lines_of_code_per_file', 'Lines of code per file over time, by language', FUN=plot_commit_stats_line)
}

